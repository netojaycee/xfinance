name: Deploy Frontend (Next.js) Blue-Green

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COOKIE_SECRET: ${{ secrets.COOKIE_SECRET }}
      NEXT_PUBLIC_COOKIE_NAME: ${{ secrets.NEXT_PUBLIC_COOKIE_NAME }}
      NEXT_PUBLIC_GROUP_COOKIE_NAME: ${{ secrets.NEXT_PUBLIC_GROUP_COOKIE_NAME }}
      NEXT_PUBLIC_ENTITY_COOKIE_NAME: ${{ secrets.NEXT_PUBLIC_ENTITY_COOKIE_NAME }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
      NODE_ENV: ${{ secrets.NODE_ENV }}
      PORT: ${{ secrets.PORT }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            .next/
            public/
            package.json
            next.config.ts
          include-hidden-files: true
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: build
      - name: Verify artifact
        run: |
          ls -la build/
          ls -la build/.next/
          ls -la build/public/
      - name: Create .env
        run: |
          echo "COOKIE_SECRET=${{ secrets.COOKIE_SECRET }}" > build/.env
          echo "NEXT_PUBLIC_COOKIE_NAME=${{ secrets.NEXT_PUBLIC_COOKIE_NAME }}" >> build/.env
          echo "NEXT_PUBLIC_GROUP_COOKIE_NAME=${{ secrets.NEXT_PUBLIC_GROUP_COOKIE_NAME }}" >> build/.env
          echo "NEXT_PUBLIC_ENTITY_COOKIE_NAME=${{ secrets.NEXT_PUBLIC_ENTITY_COOKIE_NAME }}" >> build/.env
          echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> build/.env
          echo "NODE_ENV=${{ secrets.NODE_ENV }}" >> build/.env
          echo "PORT=${{ secrets.PORT }}" >> build/.env
      - name: Rsync frontend to VPS (Blue-Green)
        run: |
          # Detect current live port
          LIVE_PORT=$(ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "curl -s http://127.0.0.1:3800/api/v1/health > /dev/null && echo 3800 || echo 3801")

          if [ "$LIVE_PORT" = "3800" ]; then
            GREEN_DIR=/var/www/html/frontend-green
            GREEN_PORT=3801
            OLD_PORT=3800
            OLD_NAME=frontend-blue
            NEW_NAME=frontend-green
          else
            GREEN_DIR=/var/www/html/frontend-blue
            GREEN_PORT=3800
            OLD_PORT=3801
            OLD_NAME=frontend-green
            NEW_NAME=frontend-blue
          fi

          echo "Deploying $NEW_NAME on port $GREEN_PORT"

          # Create green folder on VPS
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "sudo mkdir -p $GREEN_DIR && sudo chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} $GREEN_DIR"

          # Rsync files from runner to VPS green folder
          rsync -avz --delete -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" build/.next/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$GREEN_DIR/.next/
          rsync -avz --delete -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" build/public/ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$GREEN_DIR/public/
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" build/package.json ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$GREEN_DIR/
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" build/next.config.ts ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$GREEN_DIR/
          rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" build/.env ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:$GREEN_DIR/

      - name: Start Green instance & switch Nginx
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            export PATH=$PATH:/usr/local/bin:/usr/bin:/bin

            # Navigate to green folder
            cd $GREEN_DIR

            # Install dependencies
            npm install --production

            # Start new PM2 instance
            pm2 start npm --name $NEW_NAME -- start --watch --port $GREEN_PORT || pm2 reload $NEW_NAME

            # Wait for health check
            for i in {1..10}; do
              curl -s http://127.0.0.1:$GREEN_PORT/api/v1/health | grep '"status":"ok"' && break
              sleep 2
            done

            # Switch Nginx upstream
            sudo sed -i "s/server 127.0.0.1:$OLD_PORT;/server 127.0.0.1:$GREEN_PORT;/" /etc/nginx/sites-available/frontend
            sudo nginx -t
            sudo systemctl reload nginx

            # Stop old instance
            pm2 stop $OLD_NAME || true
